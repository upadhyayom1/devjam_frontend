<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Connect | Student Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background 0.3s, color 0.3s; }
        
        /* === NAVIGATION STYLES === */
        .nav-link { transition: all 0.3s ease; }
        .nav-link.active { 
            background-color: #2563eb !important; 
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
        }
        .nav-link:hover { background-color: #1e293b; color: white; }
        .nav-link.active:hover { background-color: #2563eb; }

        /* === PAGE ANIMATION === */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* === DARK MODE OVERRIDES === */
        body.dark-mode { background-color: #0f172a; color: #f1f5f9; }
        
        /* Dark Mode: Panels & Cards */
        body.dark-mode .bg-white { background-color: #1e293b; border-color: #334155; color: #f1f5f9; }
        body.dark-mode .bg-slate-50 { background-color: #0f172a; border-color: #1e293b; }
        body.dark-mode .bg-slate-100 { background-color: #334155; border-color: #475569; color: white; }
        
        /* Dark Mode: Text */
        body.dark-mode .text-slate-900 { color: #f1f5f9; }
        body.dark-mode .text-slate-600, 
        body.dark-mode .text-slate-500, 
        body.dark-mode .text-slate-400 { color: #94a3b8; }
        
        /* Dark Mode: Inputs */
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background-color: #0f172a; border-color: #334155; color: white;
        }
        
        /* === UI ELEMENTS === */
        .comments-section { max-height: 0; overflow: hidden; transition: all 0.3s ease-out; opacity: 0; }
        .comments-section.open { max-height: 500px; opacity: 1; margin-top: 15px; overflow-y: auto; }
        .map-container { position: relative; overflow: hidden; }
        .group:hover .avatar-overlay { opacity: 1; }

        /* Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #2563eb; }
        .toggle-checkbox:checked + .toggle-label { background-color: #2563eb; }
    </style>
</head>
<body class="bg-slate-50 flex h-screen overflow-hidden text-slate-900">

    <aside class="w-72 bg-slate-900 text-white flex flex-col hidden md:flex border-r border-slate-800">
        <div class="p-8 text-2xl font-black flex items-center gap-3 border-b border-slate-800">
            <div class="bg-blue-500 p-2 rounded-xl"><i class="fas fa-landmark text-white text-sm"></i></div>
            <span class="tracking-tighter">MNNITConnect</span>
        </div>
        
        <div class="px-6 pt-6">
            <div class="bg-slate-800 rounded-2xl p-4 border border-slate-700 shadow-lg">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">MY CIVIC KARMA</p>
                <div class="flex justify-between items-end">
                    <span class="text-3xl font-black text-yellow-400" id="sidebar-points">0</span>
                    <span class="text-xs font-bold text-slate-300 bg-slate-700 px-2 py-1 rounded-lg" id="sidebar-level">Rookie</span>
                </div>
                <div class="w-full bg-slate-700 h-1 mt-3 rounded-full overflow-hidden">
                    <div class="bg-yellow-400 h-full w-0 transition-all duration-1000" id="sidebar-progress"></div>
                </div>
            </div>
        </div>

        <nav class="flex-1 p-6 space-y-3">
            <button onclick="showPage('dashboard')" id="nav-dashboard" class="nav-link active flex items-center gap-4 p-4 w-full rounded-2xl font-semibold text-slate-400">
                <i class="fas fa-grid-2 w-5"></i> Dashboard
            </button>
            <button onclick="showPage('feed')" id="nav-feed" class="nav-link flex items-center gap-4 p-4 w-full rounded-2xl font-semibold text-slate-400">
                <i class="fas fa-stream w-5"></i> Campus Feed
            </button>
            <button onclick="showPage('history')" id="nav-history" class="nav-link flex items-center gap-4 p-4 w-full rounded-2xl font-semibold text-slate-400">
                <i class="fas fa-history w-5"></i> My History
            </button>
            <button onclick="showPage('profile')" id="nav-profile" class="nav-link flex items-center gap-4 p-4 w-full rounded-2xl font-semibold text-slate-400">
                <i class="fas fa-user-circle w-5"></i> My Profile
            </button>
        </nav>
    </aside>

    <main class="flex-1 overflow-y-auto">
        <header class="bg-white/80 backdrop-blur-md border-b px-10 py-5 flex justify-between items-center sticky top-0 z-50">
            <div>
                <h1 class="text-xl font-extrabold" id="header-title">Student Dashboard</h1>
                <p class="text-[11px] font-bold text-blue-500 uppercase tracking-widest" id="header-reg">Loading...</p>
            </div>
            <div class="relative">
                <button onclick="toggleProfileMenu()" class="flex items-center gap-4 hover:bg-slate-100 p-2 rounded-2xl transition-all">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-black display-name">Student</p>
                    </div>
                    <img src="" class="w-12 h-12 rounded-2xl shadow-md border-2 border-white display-avatar object-cover">
                </button>
                
                <div id="profile-menu" class="hidden absolute right-0 mt-3 w-64 bg-white rounded-[1.5rem] shadow-2xl border py-3 z-50">
                    <button onclick="showPage('profile')" class="w-full flex items-center gap-3 px-6 py-3 text-sm font-bold text-slate-600 hover:bg-blue-50 rounded-xl">
                        <i class="fas fa-user-circle"></i> Edit Profile
                    </button>
                    <button onclick="toggleSettingsModal()" class="w-full flex items-center gap-3 px-6 py-3 text-sm font-bold text-slate-600 hover:bg-blue-50 rounded-xl">
                        <i class="fas fa-cog"></i> Settings
                    </button>
                    <hr class="my-2 border-slate-200">
                    <button onclick="handleLogout()" class="w-full flex items-center gap-3 px-6 py-3 text-sm font-bold text-red-500 hover:bg-red-50 rounded-xl">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                </div>
            </div>
        </header>

        <div class="p-10 max-w-6xl mx-auto">
            
            <section id="dashboard-page" class="page-section active">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-xl border border-slate-50">
                        <h2 class="text-2xl font-black mb-6">Quick Report</h2>
                        <form id="complaintForm" class="space-y-4">
                            <input type="text" id="comp-title" required placeholder="Issue Title (e.g. Broken Fan)" class="w-full px-5 py-4 bg-slate-50 border rounded-2xl outline-none focus:border-blue-500">
                            <select id="comp-category" class="w-full px-5 py-4 bg-slate-50 border rounded-2xl">
                                <option>Hostel</option><option>Academic</option><option>Infrastructure</option><option>Cleanliness</option>
                            </select>
                            <textarea id="comp-desc" required placeholder="Description & Location" class="w-full px-5 py-4 bg-slate-50 border rounded-2xl"></textarea>
                            
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Pinpoint Location</label>
                                <div id="map" class="w-full h-48 rounded-2xl border bg-slate-100 map-container"></div>
                                <p class="text-[10px] text-slate-400">Drag marker to location.</p>
                            </div>

                            <div id="image-upload-area" class="w-full py-8 border-2 border-dashed rounded-2xl text-center cursor-pointer hover:bg-slate-50 transition">
                                <i class="fas fa-image text-slate-300 text-3xl mb-2"></i>
                                <p class="text-[10px] font-bold text-slate-500">UPLOAD PHOTO</p>
                                <input type="file" id="comp-image" accept="image/*" class="hidden">
                                <img id="image-preview" class="hidden mt-4 max-h-32 mx-auto rounded-xl object-cover">
                            </div>
                            <button type="submit" id="btn-submit-report" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-blue-600 transition-all">Submit Report</button>
                        </form>
                    </div>

                    <div class="bg-white p-10 rounded-[2.5rem] shadow-xl border border-slate-50 h-full">
                        <h2 class="text-2xl font-black mb-8">Live Campus Stats</h2>
                        <div class="h-64"><canvas id="resolvedIssuesChart"></canvas></div>
                        <p class="text-center text-xs text-slate-400 mt-4">Real-time data from Firestore</p>
                    </div>
                </div>
            </section>

            <section id="profile-page" class="page-section">
                <div class="bg-white p-10 rounded-[3rem] shadow-2xl border max-w-4xl mx-auto">
                    <div class="bg-slate-900 text-white p-8 rounded-[2.5rem] mb-10 relative overflow-hidden">
                        <div class="relative z-10 flex flex-col md:flex-row gap-8 items-center">
                            <div class="relative group cursor-pointer w-32 h-32" onclick="document.getElementById('profile-pic-input').click()">
                                <img id="profile-avatar-big" src="" class="w-full h-full rounded-full border-4 border-blue-500 object-cover shadow-2xl">
                                <div class="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center avatar-overlay opacity-0 transition-opacity"><i class="fas fa-camera text-2xl"></i></div>
                                <div id="avatar-badge" class="absolute -bottom-1 -right-1 bg-white p-2 rounded-full border-4 border-slate-900 shadow-xl z-50 flex items-center justify-center w-12 h-12 text-2xl">üê£</div>
                                <input type="file" id="profile-pic-input" accept="image/*" class="hidden">
                            </div>
                            <div class="text-center md:text-left flex-1">
                                <h2 class="text-3xl font-black display-name">Student Name</h2>
                                <p class="text-blue-400 font-bold tracking-widest text-xs uppercase mb-4" id="prof-reg-display">Reg: 2023000</p>
                                <div class="flex gap-4 justify-center md:justify-start">
                                    <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-sm"><span class="block text-2xl font-black text-yellow-400" id="prof-karma">0</span><span class="text-[10px] uppercase font-bold text-slate-400">Karma</span></div>
                                    <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-sm"><span class="block text-2xl font-black text-blue-400" id="prof-reports">0</span><span class="text-[10px] uppercase font-bold text-slate-400">Reports</span></div>
                                    <div class="bg-white/10 px-4 py-2 rounded-xl backdrop-blur-sm"><span class="block text-2xl font-black text-emerald-400" id="prof-badges-count">0</span><span class="text-[10px] uppercase font-bold text-slate-400">Badges</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="profile-edit-form">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold">Personal Details</h3>
                            <button type="submit" id="btn-save-profile" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold text-sm shadow-lg transition">Save Changes</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase">Full Name (Locked)</label><input type="text" id="edit-name" disabled class="w-full px-5 py-3 bg-slate-100 border rounded-xl font-bold text-slate-500 cursor-not-allowed"></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-400 uppercase">Registration ID (Locked)</label><input type="text" id="edit-reg" disabled class="w-full px-5 py-3 bg-slate-100 border rounded-xl font-bold text-slate-500 cursor-not-allowed"></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase">Branch</label><select id="edit-branch" class="w-full px-5 py-3 bg-white border rounded-xl"><option value="">Select Branch</option><option value="CSE">CSE</option><option value="ECE">ECE</option><option value="EE">EE</option><option value="ME">ME</option><option value="CE">Civil</option></select></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase">Year</label><select id="edit-year" class="w-full px-5 py-3 bg-white border rounded-xl"><option value="">Select Year</option><option value="1st Year">1st Year</option><option value="2nd Year">2nd Year</option><option value="3rd Year">3rd Year</option><option value="Final Year">Final Year</option></select></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase">Gender</label><select id="edit-gender" class="w-full px-5 py-3 bg-white border rounded-xl"><option value="">Select Gender</option><option value="Male">Male</option><option value="Female">Female</option></select></div>
                            <div class="space-y-2"><label class="text-[10px] font-black text-slate-500 uppercase">Mobile</label><input type="tel" id="edit-mobile" class="w-full px-5 py-3 bg-white border rounded-xl"></div>
                        </div>
                    </form>
                    <h3 class="text-xl font-bold mt-10 mb-4">Badges Collection</h3>
                    <div id="badges-container" class="flex flex-wrap gap-4 p-6 bg-slate-50 rounded-2xl border border-dashed border-slate-300"><span class="text-slate-400 text-sm italic">Start reporting issues to unlock badges!</span></div>
                </div>
            </section>

            <section id="feed-page" class="page-section"><div id="feed-container" class="space-y-6"></div></section>
            <section id="history-page" class="page-section"><div id="history-container" class="space-y-4"></div></section>
        </div>
    </main>

    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-[100] hidden flex justify-center items-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-[2rem] shadow-2xl w-96 relative border border-slate-200">
            <button onclick="toggleSettingsModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl font-black mb-6">Settings</h2>
            
            <div class="space-y-6">
                <div class="flex items-center justify-between p-4 bg-slate-50 rounded-2xl border">
                    <div class="flex items-center gap-3">
                        <div class="bg-slate-200 p-2 rounded-lg text-slate-600"><i class="fas fa-moon"></i></div>
                        <span class="font-bold text-sm">Dark Mode</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" onchange="toggleDarkMode()">
                        <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                
                <p class="text-xs text-center text-slate-400 mt-4">Version 1.0.0 ‚Ä¢ Civic Connect</p>
            </div>
        </div>
    </div>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, query, where, getDocs, serverTimestamp, updateDoc, arrayUnion, arrayRemove, orderBy, increment } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD_HB6QXbdv5z6zKXIkU18nw7k9NFOmZ5s",
            authDomain: "mnnit-devjam.firebaseapp.com",
            projectId: "mnnit-devjam",
            storageBucket: "mnnit-devjam.firebasestorage.app",
            messagingSenderId: "860519154056",
            appId: "1:860519154056:web:1f848fba6723b04419fa3d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userProfile = null;
        let currentUploadedImage = null;
        let newProfilePic = null;
        let map, marker, currentLat = 25.4913, currentLng = 81.8667;
        let issuesChart = null;

        // DARK MODE LOGIC
        window.toggleDarkMode = function() {
            const isDark = document.getElementById('dark-mode-toggle').checked;
            if(isDark) document.body.classList.add('dark-mode');
            else document.body.classList.remove('dark-mode');
            localStorage.setItem('mnnit_theme', isDark ? 'dark' : 'light');
        }

        // MAP INIT
        window.initMap = function() {
            const mnnitCenter = { lat: 25.4913, lng: 81.8667 };
            const MNNIT_BOUNDS = { north: 25.5050, south: 25.4800, west: 81.8550, east: 81.8800 };
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 16, center: mnnitCenter, streetViewControl: false, mapTypeControl: false,
                restriction: { latLngBounds: MNNIT_BOUNDS, strictBounds: false }, minZoom: 15, maxZoom: 20
            });
            marker = new google.maps.Marker({ position: mnnitCenter, map: map, draggable: true });
            marker.addListener("dragend", (e) => { currentLat = e.latLng.lat(); currentLng = e.latLng.lng(); });
            map.addListener("click", (e) => { marker.setPosition(e.latLng); currentLat = e.latLng.lat(); currentLng = e.latLng.lng(); });
        }

        // INIT & AUTH
        document.addEventListener('DOMContentLoaded', async () => {
            // Check Theme
            const theme = localStorage.getItem('mnnit_theme');
            if(theme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').checked = true;
            }

            const session = localStorage.getItem('mnnit_current_user');
            if (!session) { window.location.href = 'login.html'; return; }
            currentUser = JSON.parse(session);

            try {
                const docSnap = await getDoc(doc(db, "users", currentUser.uid));
                if (docSnap.exists()) { userProfile = docSnap.data(); updateUI(userProfile); }
            } catch (err) { console.error(err); }
            fetchChartData();
        });

        function updateUI(profile) {
            const name = profile.fullName || "Student";
            const reg = profile.registrationId || "Unknown";
            const points = profile.points || 0;
            const reportCount = profile.reportCount || 0;

            document.querySelectorAll('.display-name').forEach(el => el.innerText = name);
            document.getElementById('header-reg').innerText = `${reg} ‚Ä¢ STUDENT`;
            document.getElementById('prof-reg-display').innerText = `Reg No: ${reg}`;
            
            const avatarUrl = profile.profilePic || `https://ui-avatars.com/api/?name=${name}&background=020617&color=fff&bold=true`;
            document.querySelectorAll('.display-avatar').forEach(img => img.src = avatarUrl);
            document.getElementById('profile-avatar-big').src = avatarUrl;

            document.getElementById('sidebar-points').innerText = points;
            document.getElementById('prof-karma').innerText = points;
            document.getElementById('prof-reports').innerText = reportCount;

            document.getElementById('edit-name').value = name;
            document.getElementById('edit-reg').value = reg;
            document.getElementById('edit-branch').value = profile.branch || "";
            document.getElementById('edit-year').value = profile.year || "";
            document.getElementById('edit-gender').value = profile.gender || "";
            document.getElementById('edit-mobile').value = profile.mobile || "";

            let level="Rookie", badgeIcon="üê£", progress="10%";
            if(points>=50) { level="Scout"; badgeIcon="ü¶Ö"; progress="33%"; }
            if(points>=150) { level="Guardian"; badgeIcon="üõ°Ô∏è"; progress="66%"; }
            if(points>=500) { level="Legend"; badgeIcon="üëë"; progress="100%"; }

            document.getElementById('sidebar-level').innerText = level;
            document.getElementById('sidebar-progress').style.width = progress;
            
            const badgeEl = document.getElementById('avatar-badge');
            if(badgeEl) badgeEl.innerHTML = badgeIcon;

            const badgeContainer = document.getElementById('badges-container');
            let badgeHTML = "";
            if (points >= 10) badgeHTML += `<span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-bold border border-blue-200">üê£ First Steps</span>`;
            if (points >= 50) badgeHTML += `<span class="bg-yellow-100 text-yellow-600 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">ü¶Ö Eagle Eye</span>`;
            if (reportCount >= 5) badgeHTML += `<span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-bold border border-green-200">üßπ Green Warrior</span>`;
            if (badgeHTML) badgeContainer.innerHTML = badgeHTML;
            document.getElementById('prof-badges-count').innerText = badgeContainer.children.length;
        }

        // COMPRESSOR & PROFILE EDIT
        function compressImage(file) { return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const maxWidth = 800; const scale = maxWidth/img.width; canvas.width = maxWidth; canvas.height = img.height*scale; canvas.getContext('2d').drawImage(img,0,0,canvas.width,canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; }; }); }
        
        document.getElementById('profile-pic-input').onchange = async (e) => {
            if(e.target.files[0]) { newProfilePic = await compressImage(e.target.files[0]); document.getElementById('profile-avatar-big').src = newProfilePic; }
        };

        document.getElementById('profile-edit-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-save-profile'); btn.innerText = "Saving..."; btn.disabled = true;
            const updates = { branch: document.getElementById('edit-branch').value, year: document.getElementById('edit-year').value, gender: document.getElementById('edit-gender').value, mobile: document.getElementById('edit-mobile').value };
            if (newProfilePic) updates.profilePic = newProfilePic;
            try { await updateDoc(doc(db, "users", currentUser.uid), updates); userProfile = (await getDoc(doc(db, "users", currentUser.uid))).data(); updateUI(userProfile); alert("Updated!"); } catch(e){ alert(e.message); } finally { btn.innerText = "Save Changes"; btn.disabled = false; }
        };

        // SUBMIT REPORT
        document.getElementById('image-upload-area').onclick = () => document.getElementById('comp-image').click();
        document.getElementById('comp-image').onchange = async (e) => { currentUploadedImage = await compressImage(e.target.files[0]); document.getElementById('image-preview').src = currentUploadedImage; document.getElementById('image-preview').classList.remove('hidden'); };

        document.getElementById('complaintForm').onsubmit = async (e) => {
            e.preventDefault(); if(!currentUploadedImage) return alert("Photo required!");
            const btn = document.getElementById('btn-submit-report'); btn.innerText = "Posting..."; btn.disabled = true;
            try {
                await addDoc(collection(db, "issues"), {
                    studentId: currentUser.uid, studentName: userProfile?.fullName||"Student", title: document.getElementById('comp-title').value,
                    category: document.getElementById('comp-category').value, description: document.getElementById('comp-desc').value, imageUrl: currentUploadedImage,
                    locationLat: currentLat, locationLng: currentLng, status: "Pending", upvotedBy: [], downvotedBy: [], timestamp: serverTimestamp(), dateDisplay: new Date().toLocaleDateString()
                });
                await updateDoc(doc(db, "users", currentUser.uid), { points: increment(10), reportCount: increment(1) });
                alert("Posted! +10 Karma"); document.getElementById('complaintForm').reset(); document.getElementById('image-preview').classList.add('hidden'); currentUploadedImage = null;
                updateUI((await getDoc(doc(db, "users", currentUser.uid))).data()); showPage('feed'); fetchChartData();
            } catch(e){ alert(e.message); } finally { btn.innerText = "Submit Report"; btn.disabled = false; }
        };

        // FEED, COMMENTS & VOTES
        async function renderFeed() {
            const container = document.getElementById('feed-container'); container.innerHTML = '<p class="text-center text-slate-400">Loading feed...</p>';
            try {
                const q = query(collection(db, "issues"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q); container.innerHTML = "";
                querySnapshot.forEach(docSnap => {
                    const r = docSnap.data(); const docId = docSnap.id;
                    const score = (r.upvotedBy?.length || 0) - (r.downvotedBy?.length || 0);
                    const isUp = r.upvotedBy?.includes(currentUser.uid), isDown = r.downvotedBy?.includes(currentUser.uid);
                    container.innerHTML += `
                    <div class="bg-white p-6 rounded-[2rem] border shadow-sm mb-6">
                        <div class="flex justify-between items-start mb-4"><div><span class="bg-blue-100 text-blue-600 text-[10px] font-bold px-3 py-1 rounded-full uppercase">${r.category}</span><h3 class="text-lg font-bold mt-2">${r.title}</h3></div><span class="text-[10px] font-bold text-slate-400">${r.dateDisplay}</span></div>
                        <p class="text-sm text-slate-600 mb-3 leading-relaxed">${r.description}</p>
                        <img src="${r.imageUrl}" class="w-full h-56 object-cover rounded-2xl mb-4 bg-slate-100 border">
                        <div class="flex justify-between items-center pt-2 border-t mt-2"><div class="flex items-center gap-2"><img src="https://ui-avatars.com/api/?name=${r.studentName}&background=f1f5f9&color=64748b&bold=true" class="w-6 h-6 rounded-full"><span class="text-xs font-bold text-slate-500">${r.studentName}</span></div>
                        <div class="flex items-center gap-3"><div class="flex items-center bg-slate-100 rounded-xl overflow-hidden border border-slate-200"><button class="px-3 py-2 hover:bg-slate-200 ${isUp?'text-blue-600':'text-slate-400'}" onclick="handleVote('${docId}','up')"><i class="fas fa-arrow-up"></i></button><span class="text-xs font-black w-4 text-center text-slate-700">${score}</span><button class="px-3 py-2 hover:bg-slate-200 ${isDown?'text-red-600':'text-slate-400'}" onclick="handleVote('${docId}','down')"><i class="fas fa-arrow-down"></i></button></div><button class="px-4 py-2 bg-slate-100 rounded-xl text-xs font-bold text-slate-600 hover:bg-slate-200 transition" onclick="toggleComments('${docId}')"><i class="fas fa-comment-alt mr-1"></i> Discuss</button></div></div>
                        <div id="comments-${docId}" class="comments-section bg-slate-50 rounded-2xl border border-slate-200 mt-4 p-4"><div id="list-${docId}" class="space-y-4 mb-4 max-h-64 overflow-y-auto"></div><div class="flex gap-2 items-center bg-white p-2 rounded-xl border"><input type="text" id="input-${docId}" placeholder="Comment..." class="flex-1 px-3 py-1 text-sm outline-none"><button class="bg-blue-600 text-white p-2 rounded-lg text-xs font-bold" onclick="postComment('${docId}')"><i class="fas fa-paper-plane"></i></button></div></div>
                    </div>`;
                });
            } catch(e){console.error(e);}
        }

        window.handleVote = async function(docId, type) {
            const ref = doc(db, "issues", docId);
            const d = (await getDoc(ref)).data(); const u = currentUser.uid; let up = {};
            if(type==='up') up = d.upvotedBy?.includes(u)?{upvotedBy:arrayRemove(u)}:{upvotedBy:arrayUnion(u),downvotedBy:arrayRemove(u)};
            else up = d.downvotedBy?.includes(u)?{downvotedBy:arrayRemove(u)}:{downvotedBy:arrayUnion(u),upvotedBy:arrayRemove(u)};
            await updateDoc(ref, up); renderFeed();
        }

        window.toggleComments = (id) => { const el=document.getElementById(`comments-${id}`); if(el.classList.contains('open'))el.classList.remove('open'); else { el.classList.add('open'); loadComments(id); } };
        async function loadComments(id) {
            const d = document.getElementById(`list-${id}`); d.innerHTML='Loading...';
            const q = query(collection(db, "issues", id, "comments"), orderBy("timestamp", "asc"));
            const s = await getDocs(q); d.innerHTML=""; if(s.empty){d.innerHTML='No comments.';return;}
            s.forEach(c => { const dt=c.data(); const sc=(dt.upvotedBy?.length||0)-(dt.downvotedBy?.length||0);
                d.innerHTML += `<div class="flex gap-3"><img src="https://ui-avatars.com/api/?name=${dt.authorName}&background=cbd5e1&color=fff&size=32&bold=true" class="w-8 h-8 rounded-full"><div class="flex-1"><div class="bg-white p-3 rounded-2xl rounded-tl-none border shadow-sm inline-block"><span class="text-xs font-bold text-slate-800 block">${dt.authorName}</span><p class="text-sm text-slate-600">${dt.text}</p></div><div class="flex items-center gap-2 mt-1 ml-1"><button class="text-[10px] text-slate-400 hover:text-blue-500 font-bold" onclick="voteComment('${id}','${c.id}','up')">Upvote</button><span class="text-[10px] font-bold ${sc>0?'text-blue-500':'text-slate-400'}">${sc}</span><button class="text-[10px] text-slate-400 hover:text-red-500 font-bold" onclick="voteComment('${id}','${c.id}','down')">Downvote</button></div></div></div>`;
            });
        }
        window.postComment = async(id) => { const i=document.getElementById(`input-${id}`); if(!i.value.trim())return; await addDoc(collection(db,"issues",id,"comments"),{text:i.value.trim(),authorId:currentUser.uid,authorName:userProfile?.fullName||"Student",timestamp:serverTimestamp(),upvotedBy:[],downvotedBy:[]}); i.value=""; loadComments(id); };
        window.voteComment = async(iId, cId, type) => { const ref=doc(db,"issues",iId,"comments",cId); const d=(await getDoc(ref)).data(); const u=currentUser.uid; let up={}; if(type==='up') up=d.upvotedBy?.includes(u)?{upvotedBy:arrayRemove(u)}:{upvotedBy:arrayUnion(u),downvotedBy:arrayRemove(u)}; else up=d.downvotedBy?.includes(u)?{downvotedBy:arrayRemove(u)}:{downvotedBy:arrayUnion(u),upvotedBy:arrayRemove(u)}; await updateDoc(ref,up); loadComments(iId); };

        async function loadMyHistory() { 
            const d = document.getElementById('history-container'); d.innerHTML='Loading...';
            const q=query(collection(db,"issues"),where("studentId","==",currentUser.uid)); const s=await getDocs(q); d.innerHTML=""; if(s.empty) {d.innerHTML='No reports.';return;}
            s.forEach(doc=>{const r=doc.data(); d.innerHTML+=`<div class="bg-white p-6 rounded-[2rem] border shadow-sm flex gap-6 items-center"><img src="${r.imageUrl}" class="w-20 h-20 rounded-2xl object-cover bg-slate-100"><div><h3 class="text-lg font-bold">${r.title}</h3><span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${r.status==='Resolved'?'text-emerald-600 bg-emerald-100':'text-yellow-600 bg-yellow-100'}">${r.status}</span></div></div>`;}); 
        }
        async function fetchChartData() { try { const q=query(collection(db,"issues")); const s=await getDocs(q); let h=0,a=0,i=0,c=0; s.forEach(d=>{const v=d.data().category; if(v=='Hostel')h++;if(v=='Academic')a++;if(v=='Infrastructure')i++;if(v=='Cleanliness')c++;}); renderChart([h,a,i,c]); } catch(e){console.error(e);} }
        function renderChart(d){if(issuesChart)issuesChart.destroy(); const ctx=document.getElementById('resolvedIssuesChart').getContext('2d'); issuesChart=new Chart(ctx,{type:'bar',data:{labels:['Hostel','Academic','Infra','Cleanliness'],datasets:[{label:'Reports',data:d||[0,0,0,0],backgroundColor:['#3b82f6','#8b5cf6','#f59e0b','#10b981'],borderRadius:10}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{display:false}},x:{grid:{display:false}}}}});}
        
        window.showPage = function(pageId) {
            document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            
            document.querySelectorAll('.nav-link').forEach(btn => {
                btn.classList.remove('active'); 
                btn.classList.add('text-slate-400');
            });

            const activeBtn = document.getElementById('nav-' + pageId);
            if(activeBtn) {
                activeBtn.classList.add('active'); 
                activeBtn.classList.remove('text-slate-400');
            }

            document.getElementById('header-title').innerText = pageId.charAt(0).toUpperCase() + pageId.slice(1);
            if(pageId === 'feed') renderFeed();
            if(pageId === 'history') loadMyHistory();
        }

        window.toggleProfileMenu = () => document.getElementById('profile-menu').classList.toggle('hidden');
        window.toggleSettingsModal = () => document.getElementById('settings-modal').classList.toggle('hidden');
        window.handleLogout = async () => { await signOut(auth); localStorage.removeItem('mnnit_current_user'); window.location.href = 'login.html'; };
        window.onclick = (e) => { 
            if(!e.target.closest('.relative') && !e.target.closest('#settings-modal')) {
                document.getElementById('profile-menu').classList.add('hidden');
            } 
        };

        window.handleVote = handleVote; window.toggleComments = toggleComments; window.postComment = postComment; window.voteComment = voteComment;
    </script>
</body>
</html>